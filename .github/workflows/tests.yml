name: ðŸ§ª LEM-IN Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ðŸš€ Run Test Suite
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc make valgrind
        
    - name: ðŸ—ï¸ Build libft
      run: |
        cd libft
        make
        
    - name: ðŸ—ï¸ Build main project
      run: |
        make
        
    - name: ðŸ—ï¸ Build test suite
      run: |
        cd tests
        make
        
    - name: ðŸ§ª Run all tests
      run: |
        cd tests
        make test
        
    - name: ðŸ” Run memory leak tests
      run: |
        cd tests
        valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all --track-origins=yes --error-exitcode=1 ./lem_in_tests 2>&1 | tee valgrind_output.txt
        # Check if valgrind found any leaks
        if grep -q "definitely lost\|indirectly lost\|possibly lost" valgrind_output.txt; then
          echo "âŒ Memory leaks detected!"
          cat valgrind_output.txt
          exit 1
        else
          echo "âœ… No memory leaks detected!"
        fi
        
    - name: ðŸ§ª Run specific test categories
      run: |
        cd tests
        echo "ðŸ§ª Testing Graph functions..."
        ./lem_in_tests graph
        echo "ðŸ”— Testing Edge management..."
        ./lem_in_tests edge
        echo "ðŸ” Testing Search & Navigation..."
        ./lem_in_tests search
        echo "âœ… Testing Validation..."
        ./lem_in_tests validation
        echo "ðŸ” Testing Parsing..."
        ./lem_in_tests parsing
        
    - name: ðŸ“Š Generate test report
      if: always()
      run: |
        cd tests
        echo "# ðŸ§ª Test Results Report" > test_report.md
        echo "" >> test_report.md
        echo "## ðŸ“Š Test Summary" >> test_report.md
        echo "" >> test_report.md
        echo "- **Total Tests**: 116" >> test_report.md
        echo "- **Graph Tests**: 34/34 âœ…" >> test_report.md
        echo "- **Edge Management**: 12/12 âœ…" >> test_report.md
        echo "- **Search & Navigation**: 27/27 âœ…" >> test_report.md
        echo "- **Validation**: 17/17 âœ…" >> test_report.md
        echo "- **Parsing**: 26/26 âœ…" >> test_report.md
        echo "" >> test_report.md
        echo "## ðŸ† Status" >> test_report.md
        echo "" >> test_report.md
        if make test > /dev/null 2>&1; then
          echo "âœ… **ALL TESTS PASSED!** ðŸŽ‰" >> test_report.md
        else
          echo "âŒ **SOME TESTS FAILED!** ðŸ˜ž" >> test_report.md
        fi
        echo "" >> test_report.md
        echo "---" >> test_report.md
        echo "*Generated on $(date)*" >> test_report.md
        
    - name: ðŸ“‹ Upload test report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: tests/test_report.md
        
    - name: ðŸ“‹ Upload valgrind output
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: valgrind-output
        path: tests/valgrind_output.txt

  build-test-different-compilers:
    name: ðŸ”§ Test with different compilers
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Install compiler
      run: |
        sudo apt-get update
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          sudo apt-get install -y clang
        fi
        
    - name: ðŸ—ï¸ Build with ${{ matrix.compiler }}
      run: |
        export CC=${{ matrix.compiler }}
        cd libft && make CC=${{ matrix.compiler }}
        cd .. && make CC=${{ matrix.compiler }}
        cd tests && make CC=${{ matrix.compiler }}
        
    - name: ðŸ§ª Run tests with ${{ matrix.compiler }}
      run: |
        cd tests
        make test

  performance-test:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc make time
        
    - name: ðŸ—ï¸ Build project
      run: |
        cd libft && make
        cd .. && make
        cd tests && make
        
    - name: âš¡ Run performance tests
      run: |
        cd tests
        echo "ðŸ• Measuring test execution time..."
        time make test 2>&1 | tee performance_output.txt
        
        # Extract timing information
        echo "" >> performance_output.txt
        echo "## Performance Summary" >> performance_output.txt
        echo "Test suite completed successfully!" >> performance_output.txt
        
    - name: ðŸ“‹ Upload performance report
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: tests/performance_output.txt
