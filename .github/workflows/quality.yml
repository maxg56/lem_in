name: ğŸ” Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  norminette:
    name: ğŸ“ Norminette Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: ğŸ“ Install Norminette
      run: |
        pip install norminette
        
    - name: ğŸ” Check source files
      run: |
        echo "ğŸ” Checking src/ directory..."
        norminette src/ || echo "âš ï¸ Norminette issues found in src/"
        
    - name: ğŸ” Check include files
      run: |
        echo "ğŸ” Checking include/ directory..."
        norminette include/ || echo "âš ï¸ Norminette issues found in include/"
        
    - name: ğŸ” Check libft
      run: |
        echo "ğŸ” Checking libft/ directory..."
        norminette libft/src/ libft/include/ || echo "âš ï¸ Norminette issues found in libft/"

  static-analysis:
    name: ğŸ”¬ Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-tidy
        
    - name: ğŸ”¬ Run cppcheck
      run: |
        echo "ğŸ”¬ Running cppcheck static analysis..."
        cppcheck --enable=all --inconclusive --std=c99 \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          src/ include/ 2>&1 | tee cppcheck_report.txt
          
    - name: ğŸ“‹ Upload cppcheck report
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-report
        path: cppcheck_report.txt

  compilation-warnings:
    name: âš ï¸ Compilation Warnings
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Build with strict warnings
      run: |
        echo "ğŸ”§ Building with strict warning flags..."
        cd libft
        make CFLAGS="-Wall -Wextra -Werror -Wpedantic -Wconversion -Wshadow -std=c99"
        cd ..
        make CFLAGS="-Wall -Wextra -Werror -Wpedantic -Wconversion -Wshadow -std=c99"
        
    - name: ğŸ§ª Build tests with warnings
      run: |
        cd tests
        make CFLAGS="-Wall -Wextra -Werror -Wpedantic -Wconversion -Wshadow -std=c99"

  documentation:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“š Check README files
      run: |
        echo "ğŸ“š Checking documentation completeness..."
        
        # Check main README
        if [ ! -f README.md ]; then
          echo "âŒ Main README.md is missing!"
          exit 1
        else
          echo "âœ… Main README.md exists"
        fi
        
        # Check test documentation
        if [ ! -f tests/README.md ]; then
          echo "âŒ Test README.md is missing!"
          exit 1
        else
          echo "âœ… Test README.md exists"
        fi
        
        # Check for basic content
        if grep -q "lem-in" README.md; then
          echo "âœ… README mentions lem-in"
        else
          echo "âš ï¸ README should mention lem-in"
        fi
        
    - name: ğŸ“Š Check function documentation
      run: |
        echo "ğŸ“Š Checking function documentation..."
        
        # Look for functions without comments
        echo "Functions that might need documentation:"
        grep -r "^[a-zA-Z_][a-zA-Z0-9_]*\s*(" src/ include/ --include="*.c" --include="*.h" | \
        grep -v "//" | head -10 || echo "âœ… All functions seem documented"

  security:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Check for security issues
      run: |
        echo "ğŸ”’ Checking for potential security issues..."
        
        # Check for dangerous functions
        echo "Checking for dangerous function usage..."
        if grep -r "strcpy\|strcat\|sprintf\|gets" src/ include/ --include="*.c" --include="*.h"; then
          echo "âš ï¸ Found potentially unsafe functions!"
        else
          echo "âœ… No obviously dangerous functions found"
        fi
        
        # Check for hardcoded values that might be problematic
        echo "Checking for potential hardcoded issues..."
        if grep -r "TODO\|FIXME\|XXX\|HACK" src/ include/ --include="*.c" --include="*.h"; then
          echo "âš ï¸ Found TODO/FIXME comments that should be addressed"
        else
          echo "âœ… No TODO/FIXME comments found"
        fi
